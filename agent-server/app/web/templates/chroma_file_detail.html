<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>文件 {{ file_name }} - 父 Chunk 详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="mx-auto max-w-7xl px-4 py-8">
      <div
        class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between"
      >
        <div>
          <h1 class="text-2xl font-semibold">文件视图：{{ file_name }}</h1>
          <p class="text-sm text-slate-600">
            父 chunk 总数：<span class="font-semibold">{{ total }}</span> ·
            筛选：<span class="font-mono">{{ q or "全部" }}</span>
          </p>
        </div>
        <div class="flex gap-2">
          <a
            class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-900 hover:bg-slate-50"
            href="/chroma/files"
            >← 返回文件列表</a
          >
        </div>
      </div>

      <div class="mt-6 grid gap-6 lg:grid-cols-[320px,1fr]">
        <div class="space-y-4">
          <form
            class="rounded-xl border border-slate-200 bg-white p-4"
            action="/chroma/file/{{ file_name | urlencode }}"
            method="get"
          >
            <div class="text-sm font-semibold text-slate-600">筛选父 chunk</div>
            <div class="mt-3 space-y-3">
              <div>
                <label class="text-xs font-medium text-slate-500"
                  >文本 contains (LIKE)</label
                >
                <input
                  class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
                  name="q"
                  value="{{ q }}"
                  placeholder="例如：章节标题"
                />
              </div>
              <div>
                <label class="text-xs font-medium text-slate-500"
                  >page_size</label
                >
                <input
                  class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
                  name="page_size"
                  type="number"
                  min="5"
                  max="200"
                  value="{{ page_size }}"
                />
              </div>
              <input type="hidden" name="page" value="1" />
              <div class="flex justify-end">
                <button
                  class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800"
                  type="submit"
                >
                  应用过滤
                </button>
              </div>
            </div>
          </form>

          <div class="rounded-xl border border-slate-200 bg-white">
            <div
              class="flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-600"
            >
              <span>父 chunk 列表</span>
              <span class="text-xs text-slate-400">按创建时间倒序</span>
            </div>
            <div class="divide-y divide-slate-100">
              {% for p in parents %} {% set is_active = p.parent_id ==
              selected_parent_id %}
              <a
                class="block space-y-1 px-4 py-3 text-sm text-slate-800 hover:bg-slate-50 {% if is_active %}bg-slate-100{% endif %}"
                href="/chroma/file/{{ file_name | urlencode }}?parent_id={{ p.parent_id | urlencode }}&q={{ q | urlencode }}&page={{ page }}&page_size={{ page_size }}"
              >
                <div class="flex items-center justify-between">
                  <span class="font-mono text-xs text-slate-500"
                    >ID {{ p.parent_id }}</span
                  >
                  <span class="text-xs text-slate-500"
                    >{{ p.file_name or "unknown" }}</span
                  >
                </div>
                <div
                  class="text-sm leading-relaxed text-slate-900"
                  style="
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                  "
                >
                  {{ (p.assembled_text or "")[:180] }}{% if (p.assembled_text or "")
                  | length > 180 %}...{% endif %}
                </div>
              </a>
              {% else %}
              <div class="px-4 py-6 text-sm text-slate-500">
                当前没有符合条件的父 chunk。
              </div>
              {% endfor %}
            </div>
            <div
              class="flex items-center justify-between px-4 py-3 text-xs text-slate-500"
            >
              <span>第 {{ page }} 页 · 共 {{ total }} 条</span>
              <div class="flex gap-2">
                {% if page > 1 %}
                <a
                  class="rounded-lg border border-slate-200 px-3 py-1 hover:bg-slate-50"
                  href="/chroma/file/{{ file_name | urlencode }}?q={{ q | urlencode }}&page={{ page - 1 }}&page_size={{ page_size }}"
                  >上一页</a
                >
                {% endif %} {% if page < total_pages %}
                <a
                  class="rounded-lg border border-slate-200 px-3 py-1 hover:bg-slate-50"
                  href="/chroma/file/{{ file_name | urlencode }}?q={{ q | urlencode }}&page={{ page + 1 }}&page_size={{ page_size }}"
                  >下一页</a
                >
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          {% if selected_parent and selected_parent.found %}
          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div
              class="flex items-center justify-between text-sm font-semibold text-slate-600"
            >
              <span>父 chunk 详情</span>
              <div class="flex items-center gap-2 text-xs">
                {% if selected_parent.found %}
                <form
                  action="/chroma/parent/{{ selected_parent.parent_id | urlencode }}/delete"
                  method="post"
                  onsubmit="return confirm('确认删除该父 chunk 以及其所有子 chunk？操作不可恢复。')"
                >
                  <button
                    class="rounded-lg bg-rose-600 px-3 py-1 text-xs font-medium text-white hover:bg-rose-500"
                    type="submit"
                  >
                    删除父 chunk
                  </button>
                </form>
                {% endif %}
                <button
                  class="rounded-lg border border-slate-200 bg-white px-3 py-1 text-xs hover:bg-slate-50"
                  type="button"
                  id="openMetadataDrawer"
                >
                  查看 metadata
                </button>
              </div>
            </div>
            <div class="mt-3 grid gap-3">
              <div>
                <div class="text-xs text-slate-500">parent_id</div>
                <div class="font-mono text-sm text-slate-800">
                  {{ selected_parent.parent_id }}
                </div>
              </div>

              <form
                class="rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600"
                action="/chroma/parent/{{ selected_parent.parent_id | urlencode }}/child/add"
                method="post"
              >
                <div class="text-[10px] font-semibold uppercase tracking-wide text-slate-500">
                  新增 子 chunk
                </div>
                <textarea
                  name="text"
                  required
                  rows="2"
                  class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs leading-normal text-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
                  placeholder="输入新的子 chunk 文本"
                ></textarea>
                <input type="hidden" name="file_name" value="{{ file_name }}" />
                <input type="hidden" name="q" value="{{ q }}" />
                <input type="hidden" name="page" value="{{ page }}" />
                <input type="hidden" name="page_size" value="{{ page_size }}" />
                <div class="mt-2 flex items-center justify-between text-[11px] text-slate-400">
                  <span>添加将定位于该父 chunk 的末尾</span>
                  <button
                    type="submit"
                    class="rounded-lg bg-slate-900 px-3 py-1 text-xs font-medium text-white hover:bg-slate-800"
                  >
                    添加
                  </button>
                </div>
              </form>

              <div>
                <div
                  class="flex items-center justify-between text-xs text-slate-500"
                >
                  <span>子 chunk（{{ children | length }} 条）</span>
                  <span>按 child_index 排序</span>
                </div>
                <div class="mt-2 space-y-2">
                  {% for c in children %}
                  <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs leading-relaxed text-slate-900">
                    <div class="flex">
                      <span class="font-medium text-blue-500 bg-slate-200 p-1"
                        >c-[{{ c.child_index }}]</span
                      >
                      <span class="text-slate-700 ml-2 flex-1 p-1 bg-slate-100"
                        >{{ c.text }}</span
                      >
                    </div>
                    <details class="mt-1 space-y-2 rounded border border-slate-200 bg-white px-2 py-2 text-[10px] text-slate-600">
                      <summary class="cursor-pointer text-slate-500">展开 编辑 / 删除</summary>
                      <form
                        action="/chroma/child/{{ c.id | urlencode }}/update"
                        method="post"
                        class="space-y-2"
                      >
                        <textarea
                          name="text"
                          required
                          rows="2"
                          class="w-full rounded-lg border border-slate-200 px-2 py-1 text-[11px] text-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
                        >{{ c.text }}</textarea>
                        <input type="hidden" name="file_name" value="{{ file_name }}" />
                        <input type="hidden" name="parent_id" value="{{ selected_parent.parent_id }}" />
                        <input type="hidden" name="q" value="{{ q }}" />
                        <input type="hidden" name="page" value="{{ page }}" />
                        <input type="hidden" name="page_size" value="{{ page_size }}" />
                        <button
                          type="submit"
                          class="rounded-lg bg-slate-900 px-3 py-1 text-[11px] font-medium text-white hover:bg-slate-800"
                        >
                          保存修改
                        </button>
                      </form>
                      <form
                        action="/chroma/chunk/{{ c.id | urlencode }}/delete"
                        method="post"
                        onsubmit="return confirm('确认删除该子 chunk？此操作不可恢复。')"
                      >
                        <input type="hidden" name="file_name" value="{{ file_name }}" />
                        <input type="hidden" name="parent_id" value="{{ selected_parent.parent_id }}" />
                        <input type="hidden" name="q" value="{{ q }}" />
                        <input type="hidden" name="page" value="{{ page }}" />
                        <input type="hidden" name="page_size" value="{{ page_size }}" />
                        <button
                          type="submit"
                          class="rounded-lg border border-rose-500 bg-white px-3 py-1 text-[11px] font-medium text-rose-600 hover:bg-rose-50"
                        >
                          删除子 chunk
                        </button>
                      </form>
                    </details>
                  </div>
                  {% else %}
                  <div
                    class="rounded-lg border border-dashed border-slate-200 bg-white p-2 text-xs text-slate-500"
                  >
                    当前父 chunk 暂无子 chunk。
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div
            class="rounded-xl border border-slate-200 bg-white p-6 text-sm text-slate-500"
          >
            未选择父 chunk 或所选父 chunk 不存在，请从左侧列表选择。
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div
      id="metadataDrawer"
      class="fixed inset-0 z-50 hidden"
      aria-hidden="true"
    >
      <div
        class="absolute inset-0 bg-slate-900/60"
        onclick="closeMetadataDrawer()"
      ></div>
      <div
        class="absolute inset-y-0 right-0 flex h-full w-full max-w-3xl flex-col overflow-hidden rounded-l-2xl bg-white shadow-2xl"
      >
        <div
          class="flex items-center justify-between border-b border-slate-200 px-4 py-3"
        >
          <div class="text-sm font-semibold text-slate-700">
            父 chunk Metadata
          </div>
          <button
            type="button"
            class="rounded-lg border border-slate-200 bg-white px-3 py-1 text-xs hover:bg-slate-50"
            onclick="closeMetadataDrawer()"
          >
            关闭
          </button>
        </div>
        <div class="overflow-hidden overflow-y-auto px-4 py-3 space-y-4">
          <pre
            id="parentMetadata"
            class="mt-1 max-w-full overflow-x-auto whitespace-pre-wrap rounded-lg bg-slate-950 p-3 text-xs text-slate-50"
          >
{{ parent_metadata_json }}</pre
          >
          <div>
            <div
              class="text-xs font-semibold uppercase tracking-wide text-slate-500"
            >
              父 chunk 内容
            </div>
            <pre
              class="mt-2 max-h-60 overflow-auto rounded-lg bg-slate-50 p-3 text-xs text-slate-900 whitespace-pre-wrap"
            >
{{ selected_parent_text }}</pre
            >
          </div>
        </div>
        <div
          class="flex flex-col gap-2 border-t border-slate-200 px-4 py-3 md:flex-row md:items-center md:justify-between"
        >
          <button
            type="button"
            class="rounded-lg border border-slate-200 bg-white px-3 py-1 text-xs hover:bg-slate-50"
            id="copyMetadata"
            onclick="copyText('parentMetadata')"
          >
            复制 Metadata
          </button>
          <div class="text-xs text-slate-500 md:text-right">
            目前展示完整父 chunk 内容，可滑动查看。
          </div>
        </div>
      </div>
    </div>

    <script>
      async function copyText(id) {
        const el = document.getElementById(id);
        const text = el ? el.innerText : "";
        if (!text) return;
        try {
          await navigator.clipboard.writeText(text);
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }

      function showMetadataDrawer() {
        const drawer = document.getElementById("metadataDrawer");
        if (drawer) {
          drawer.classList.remove("hidden");
        }
      }

      function closeMetadataDrawer() {
        const drawer = document.getElementById("metadataDrawer");
        if (drawer) {
          drawer.classList.add("hidden");
        }
      }

      document
        .getElementById("openMetadataDrawer")
        ?.addEventListener("click", showMetadataDrawer);
    </script>
  </body>
</html>
