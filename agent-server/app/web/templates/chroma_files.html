<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>按文件查看 - ChromaDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="mx-auto max-w-6xl px-4 py-8">
      <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
        <div>
          <h1 class="text-2xl font-semibold">按文件查看</h1>
          <p class="mt-1 text-sm text-slate-600">
            collection: <span class="font-mono">{{ info.collection_name }}</span>
            · persist: <span class="font-mono">{{ info.persist_dir }}</span>
            {% if info.parent_count is not none %}
              · 父 chunk: <span class="font-semibold">{{ info.parent_count }}</span>
            {% endif %}
          </p>
        </div>
        <div class="flex flex-wrap gap-2">
          <a
            class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800"
            href="/chroma/files"
            >当前视图</a
          >
          <a
            class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-900 hover:bg-slate-50"
            href="/chroma/chunks"
            >所有 chunks</a
          >
          <form
            action="/chroma/clear"
            method="post"
            onsubmit="return confirm('确认清空所有 chunk 吗？此操作不可恢复。')"
          >
            <button
              class="rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-500"
              type="submit"
            >
              清空所有 chunk
            </button>
          </form>
        </div>
      </div>

      <div class="mt-8 overflow-hidden rounded-xl border border-slate-200 bg-white">
        <div class="border-b border-slate-200 px-4 py-3">
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div class="text-sm font-semibold text-slate-600">基于文件名汇总的父 chunk</div>
            {% if files %}
            <div class="text-xs text-slate-500">
              第 {{ page }} 页 · 共 {{ total }} 条
            </div>
            {% endif %}
          </div>
          
          <!-- 搜索和排序表单 -->
          <form method="get" class="mt-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div class="flex flex-1 items-center gap-2">
              <input
                type="text"
                name="search"
                value="{{ search }}"
                placeholder="搜索文件名..."
                class="flex-1 rounded-lg border border-slate-200 px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
              />
              <button
                type="submit"
                class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800"
              >
                搜索
              </button>
              {% if search %}
              <a
                href="/chroma/files?page=1&page_size={{ page_size }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
              >
                清除
              </a>
              {% endif %}
            </div>
            <input type="hidden" name="page" value="1" />
            <input type="hidden" name="page_size" value="{{ page_size }}" />
          </form>
        </div>
        {% if not files %}
          <div class="px-4 py-6 text-sm text-slate-500">当前 collection 没有父 chunk 记录。</div>
        {% else %}
          <div class="overflow-x-auto">
            <table class="w-full table-auto text-sm">
              <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-600">
                <tr>
                  <th class="px-4 py-3 text-left">
                    <a href="/chroma/files?page={{ page }}&page_size={{ page_size }}&search={{ search | urlencode }}&sort_by=name&sort_order={% if sort_by == 'name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="hover:text-slate-900">
                      文件名
                      {% if sort_by == 'name' %}
                        {% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th class="px-4 py-3 text-left">父 chunk 总数</th>
                  <th class="px-4 py-3 text-left">内容类型</th>
                  <th class="px-4 py-3 text-left">
                    <a href="/chroma/files?page={{ page }}&page_size={{ page_size }}&search={{ search | urlencode }}&sort_by=updated&sort_order={% if sort_by == 'updated' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="hover:text-slate-900">
                      最近更新
                      {% if sort_by == 'updated' %}
                        {% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th class="px-4 py-3 text-right">操作</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                {% for f in files %}
                <tr>
                  <td class="px-4 py-3 font-mono text-xs text-slate-700">{{ f.file_name }}</td>
                  <td class="px-4 py-3 font-semibold">{{ f.total_parents }}</td>
                  <td class="px-4 py-3">
                    {% for ct, cnt in f.content_types.items() %}
                      <span class="mr-2 inline-flex items-center rounded-full bg-slate-100 px-2 py-1 text-xs font-mono text-slate-700">{{ ct }}: {{ cnt }}</span>
                    {% endfor %}
                  </td>
                  <td class="px-4 py-3 text-xs text-slate-500">
                    {{ f.latest_created_at or "未知" }}
                  </td>
                  <td class="px-4 py-3 text-right">
                    <div class="flex items-center justify-end gap-2">
                      <a
                        class="text-sm font-medium text-slate-900 hover:underline"
                        href="/chroma/file/{{ f.file_name | urlencode }}"
                        >详情 →</a
                      >
                      <form
                        action="/chroma/file/{{ f.file_name | urlencode }}/delete"
                        method="post"
                        onsubmit="return confirm('确认删除 {{ f.file_name }} 的所有 chunk？此操作不可恢复。')"
                      >
                        <button
                          class="rounded-lg border border-rose-500 px-3 py-1 text-xs font-medium text-rose-600 hover:bg-rose-50"
                          type="submit"
                        >
                          删除
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div
            class="flex flex-col gap-2 border-t border-slate-200 px-4 py-3 text-xs text-slate-500 md:flex-row md:items-center md:justify-between"
          >
            <div class="flex items-center gap-2">
              <span>第 {{ page }} 页 · 共 {{ total }} 条</span>
              <form method="get" class="inline">
                <select
                  name="page_size"
                  onchange="this.form.submit()"
                  class="rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
                >
                  <option value="10" {% if page_size == 10 %}selected{% endif %}>10 条/页</option>
                  <option value="20" {% if page_size == 20 %}selected{% endif %}>20 条/页</option>
                  <option value="50" {% if page_size == 50 %}selected{% endif %}>50 条/页</option>
                  <option value="100" {% if page_size == 100 %}selected{% endif %}>100 条/页</option>
                </select>
                <input type="hidden" name="page" value="{{ page }}" />
                <input type="hidden" name="search" value="{{ search }}" />
                <input type="hidden" name="sort_by" value="{{ sort_by }}" />
                <input type="hidden" name="sort_order" value="{{ sort_order }}" />
              </form>
            </div>
            <div class="flex gap-2">
              {% if page > 1 %}
              <a
                class="rounded-lg border border-slate-200 px-3 py-1 hover:bg-slate-50"
                href="/chroma/files?page={{ page - 1 }}&page_size={{ page_size }}&search={{ search | urlencode }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                >上一页</a
              >
              {% endif %} {% if page < total_pages %}
              <a
                class="rounded-lg border border-slate-200 px-3 py-1 hover:bg-slate-50"
                href="/chroma/files?page={{ page + 1 }}&page_size={{ page_size }}&search={{ search | urlencode }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                >下一页</a
              >
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </body>
</html>
